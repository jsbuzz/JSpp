<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<title>js++ iterator demo</title>
	
	<style type="text/css">
		* {
			font-family: Calibri,Helvetia,sans-serif;
		}

		body {
			padding:5px 20px;
			margin:0;
		}
		pre {
			margin:0;
			padding:0;
		}

	</style>

	<script type="text/javascript" src="../js++.js"></script>
	<script type="text/javascript">

	_DEBUG = false;
	
	function debug(txt,toConsole)
	{
		document.getElementById('debug').innerHTML = document.getElementById('debug').innerHTML+'<span>'+(
				typeof(txt)!='string' ? 
					JSON.stringify(txt) : 
					txt.replace(/</g,'&lt;').replace(/>/g,'&gt;')
			)+'</span>\n';
		if(toConsole && console && typeof(console.info) == 'function')
			console.info(txt);
	}
		
	/** *************************************************************************************************************** Iterator
	* Iterator interface
	*/
	var Iterator = Class.interface(
		'rewind',
		'current',
		'key',
		'next',
		'valid'
	);


	/**
	* Iterator.foreach
	*/
	Iterator.foreach = function(iterator,action){
		if(!Class.instanceOf(iterator,Iterator))
			iterator = new ObjectIterator(iterator);

		for(iterator.rewind();iterator.valid();iterator.next())
			action(iterator);
	};


	/** *************************************************************************************************************** $AccessModel
	* $AccessModel class
	*/
	var $AccessModel = function(){

		this.$ = function(access,set)
		{
			var me = this;
			if(typeof(me[access])!='undefined')
				return set===undefined ? me[access] : (me[access]=set);
			if(typeof(me.protected[access])!='undefined')
				return set===undefined ? me.protected[access] : (me.protected[access]=set);
			
			throw new Error('$ Access to undefined property: '+access);
		};

		this.$$ = function(query){
			var varName = query,
			    operatorPos = query.length,
					me = this;
			
			for(var i=0;i<query.length;i++)
			{
				if(!query.charAt(i).match(/\w/))
				{
					varName=varName.substr(0,i);
					operatorPos=i;
					break;
				}
			}
			if(typeof(me[varName])!='undefined')
				varName = 'this.'+varName;
			else if(typeof(me.protected[varName])!='undefined')
				varName = 'this.protected.'+varName;
			else
				throw new Error('$$ Access to undefined property: '+varName);

			return eval('('+varName+query.substr(operatorPos)+')');
		};

	};


	/** *************************************************************************************************************** ArrayIterator
	* class ArrayIterator : Iterator,$AccessModel
	*/
	var ArrayIterator = function(target){

		// protected scope
		this.protected({
				target   : target,
				position : 0,
			});


		// methods
		this.rewind = function(){
			this.$$('position=0');
			return this;
		};

		this.current = function(){
			return this.$('target')[this.$('position')]
		};

		this.key = function(){
			return this.$('position')
		};

		this.next = function(){
			this.$$('position++');
			return this;
		};

		this.valid = function(){
			return this.$('position') < this.$('target').length
		};
	}
	.inherits([Iterator,$AccessModel]);

	
	/** *************************************************************************************************************** ObjectIterator
	* class ObjectIterator : Iterator
	*/
	var ObjectIterator = function(target){
		
		// protected scope
		this.protected({
				target   : target,
		    keys     : [],
				position : 0,
			});

		// map keys
		for(var i in target)
			this.protected.keys.push(i);

		// methods
		this.rewind  = function(){ this.protected.position = 0; return this; };
		this.current = function(){ return this.protected.target[this.protected.keys[this.protected.position]] };
		this.key     = function(){ return this.protected.keys[this.protected.position] };
		this.next    = function(){ this.protected.position++; return this; };
		this.valid   = function(){ return this.protected.position<this.protected.keys.length };
	}
	.inherits(Iterator);
	
	
	/** *************************************************************************************************************** ConditionedObjectIterator
	* class ConditionedObjectIterator : ObjectIterator
	*/
	var ConditionedObjectIterator = function(target,condition){

		// overwrite protected scope
		this.protected.target = target;
		this.protected.condition = condition;
		for(var i in target)
		{
			if(condition(target[i]))
				this.protected.keys.push(i);
		}
	}
	.inherits(ObjectIterator,'(target)=>ObjectIterator()');
	
	
	/** *************************************************************************************************************** PropertyIterator
	* class PropertyIterator : ConditionedObjectIterator
	*/
	var PropertyIterator = function(target){}
		.inherits(
			ConditionedObjectIterator,
			/* as */ function(target){return [target,function(t){return typeof(t)!="function"}]}
		);


	/** *************************************************************************************************************** MethodIterator
	* class MethodIterator : ConditionedObjectIterator
	*/
	var MethodIterator = function(target){}.inherits(ConditionedObjectIterator,
		'(target)=>(target,function(t){return typeof(t)=="function"})');


	/** *************************************************************************************************************** DOM_Iterator
	* class DOM_Iterator : Iterator
	*/
	var DOM_Iterator = function(element){

		// protected scope
		this.protected({
				target   : element || document,
		    current  : element,
				depth    : 0
			});


		// methods
		this.rewind  = function(){ this.protected.current = this.protected.target; return this; };
		this.current = function(){ return this.protected.current };
		this.key     = function(){ return this.protected.current.tagName };
		this.next    = function(){
			
			var current = this.protected.current; // shorter alias

			if(current.childElementCount)
			{
				current = current.firstElementChild;
				this.protected.depth++;
			}
			else if(current.nextElementSibling)
			{
				current = current.nextElementSibling;
			}
			else
			{
				while(current && current!=this.protected.target)
				{
					this.protected.depth--;
					current = current.parentElement;
					if(current && current.nextElementSibling)
						break;
				}
				if(!current || current==this.protected.target)
					current = null;
				else
					current = current.nextElementSibling;
			}
			this.protected.current = current;
		};
		
		this.valid   = function(){ return this.protected.current };
		this.depth   = function(){ return this.protected.depth };

	}.inherits(Iterator);



	/** *************************************************************************************************************** Iterator.extend
	* extend showoff as usual :)
	*/
	Iterator.extend({
		foreach : function(action){Iterator.foreach(this,action)}
	},true);


	/** *************************************************************************************************************** tests
	* # tests
	*/
	function loadTest()
	{
		// ArrayIterator test
		debug('\nforeach<ArrayIterator>: [1,2,3]');
		var array = [1,2,3],
		    ai = new ArrayIterator(array);

		Iterator.foreach(ai,function(i){
			debug(i.key()+' : '+i.current());
		});
		
		
		// ObjectIterator test
		debug('\nforeach<ObjectIterator>: {a:1,b:2,c:3}');
		var object = {a:1,b:2,c:3},
		    oi = new ObjectIterator(object);

		Iterator.foreach(oi,function(i){
			debug(i.key()+' : '+i.current());
		});
		
		
		// PropertyIterator test
		debug('\nforeach<PropertyIterator>: {a: function(){return 1}, b:2, c: function(){return 3}, d:4}');
		var object = {a:function(){return 1},b:2,c:function(){return 3},d:4},
		    pi = new PropertyIterator(object);

		Iterator.foreach(pi,function(i){
			debug(i.key()+' : '+i.current());
		});
		
		// MethodIterator test
		debug('\nforeach<MethodIterator>: {a: function(){return 1}, b:2, c: function(){return 3}, d:4}');
		var mi = new MethodIterator(object);

		Iterator.foreach(mi,function(i){
			debug(i.key()+' : '+i.current());
		});

		
		// DOM_Iterator test
		var dom = new DOM_Iterator(document.body),
		    puffer = []; // we shouldn't write the dom while reading it

		dom.foreach(function(i){
			puffer.push(
				new Array(i.depth()+1).join('\t')
				+ i.key()
				+ (i.key()=='SPAN' ? ' ['+i.current().innerText.replace(/\n/g,'')+']' : '')
			);
		});
		
		debug('\nforeach<DOM_Iterator> : BODY');
		Iterator.foreach(puffer,function(i){
			debug(i.current());
		});
	}
	</script>

</head>

<body onload="loadTest()">
	<pre id="debug"></pre>
</body>
</html>